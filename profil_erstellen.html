<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Profil Erstellen</title>
  <script src="jspsych-7.1.2/dist/jspsych.js"></script>
  <script src="jspsych-7.1.2/dist/plugin-html-button-response.js"></script>
  <script src="jspsych-7.1.2/dist/plugin-html-keyboard-response.js"></script>
  <script src="jspsych-7.1.2/dist/plugin-survey-text.js"></script>
  <link href="jspsych-7.1.2/dist/jspsych.css" rel="stylesheet" />
  <link rel="stylesheet" href="style.css">
  <!-- Cropper.js CSS -->
  <link  href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
  <!-- Cropper.js JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  <style>
    body { background-color: white; color: black; font-size: 18px; }
    #input-0 { font-size: 16px; }
  </style>
</head>
<body>
  <script src="question_strings.js"></script>
</body>
<script>
// --- Load IDs first ---
let validIDs = [];
let redoProfilePic = false;
let currentImagePath = "";   // global image path (determined before preview)

fetch('ids.json')
  .then(response => response.json())
  .then(data => {
    validIDs = data;
    startExperiment();
  })
  .catch(err => {
    alert("Konnte die ID-Datenbank nicht laden.");
    console.error(err);
  });

function startExperiment() {
  const jsPsych = initJsPsych();

  function saveData(filename, filedata){
    var xhr = new XMLHttpRequest();
    xhr.open('POST', 'write_data.php'); 
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.onreadystatechange = function() {
      if (xhr.readyState === 4) {
        if(xhr.status === 200){
          console.log(xhr.responseText);
        } else {
          console.error("Error saving data:", xhr.responseText);
        }
      }
    };
    xhr.send(JSON.stringify({filename: filename, filedata: filedata}));
  }

  // --- Add logo to the page ---
  const logo = document.createElement('img');
  logo.src = 'zi.png';  // make sure this file is in the same folder as your HTML
  logo.className = 'top-logo';
  document.body.prepend(logo);  // adds logo at the top of body

  // --- ID input ---
  const id_input = {
    type: jsPsychSurveyText,
    questions: [{ 
      prompt: "Bitte gib deine Teilnehmer-ID ein (5 Zeichen):", 
      rows: 1, 
      columns: 15, 
      required: true, 
      name: "participant_id" 
    }],
    button_label: "Weiter",
    css_classes: ['id-panel'],
    on_start: function() {
      const wrapper = document.querySelector('.jspsych-content-wrapper');

      // Add logo if not already added
      if (!wrapper.querySelector('.top-logo')) {
        const logo = document.createElement('img');
        logo.src = 'zi.png';  // must be in same folder
        logo.className = 'top-logo';
        wrapper.prepend(logo);
      }

      // Add footnote if not already added
      if (!wrapper.querySelector('.footnote')) {
        const footnote = document.createElement('div');
        footnote.className = 'footnote';
        footnote.innerText = '© 2025 ZI Mannheim – Alle Rechte vorbehalten';
        wrapper.appendChild(footnote);
      }
    },
    on_finish: function(data) {
      const id = jsPsych.data.getLastTrialData().trials[0].response.participant_id.trim();
      if(!/^[A-Za-z0-9]{5}$/.test(id)) {
        alert("ID muss genau 5 Zeichen haben.");
        data.valid_id = false;
      } else if (!validIDs.includes(id)) {
        alert("ID nicht gefunden.");
        data.valid_id = false;
      } else {
        data.valid_id = true;
        jsPsych.data.addProperties({participant_id: id});
      }
    }
  };

  const id_timeline = {
    timeline: [id_input],
    loop_function: function(data) { return !data.values()[0].valid_id; }
  };

  const welcome = {
  type: jsPsychHtmlButtonResponse,
  stimulus: `<div class="fade-container"> 
              <h2>Willkommen!</h2>
              <p>Im folgenden wirst du dein Profil erstellen.</p> 
              <p>Dein Profil wird aus einem Profilbild und fünf Informationen bestehen.</p>
            </div>`,
  choices: ["Weiter"],
  css_classes: ['id-panel'],
  on_start: function(trial) {
  // fade in after content is added to DOM
  setTimeout(() => {
    const container = document.querySelector('.fade-container');
    if(container) container.classList.add('visible');
  }, 10);
  },
  on_finish: function() {
  // fade out before next trial
  const container = document.querySelector('.fade-container');
  if(container) container.classList.remove('visible');
  }
  };

  const question_instructions = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `
                <div class="fade-container">
                <p>Nun werden wir dir einige Fragen stellen. Bitte beantworte die Fragen in 2-3 kurzen Sätzen.</p> 
                <p>Deine Antworten werden <b>Teil deines Profils sein.</b></p>
                </div>
                `,
      choices: ["Weiter"],
      css_classes: ['id-panel'],
      on_start: function(trial) {
      // fade in after content is added to DOM
      setTimeout(() => {
        const container = document.querySelector('.fade-container');
        if(container) container.classList.add('visible');
      }, 10);
    },
    on_finish: function() {
      // fade out before next trial
      const container = document.querySelector('.fade-container');
      if(container) container.classList.remove('visible');
    }
    };

  // --- Profile picture upload & crop trial ---
  const profile_pic_trial = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <div class="fade-container">
        <p><b>Bitte wähle nun dein Profilbild aus:</b></p>
        <input type="file" id="profilePicInput" accept="image/*">
        <br><br>
        <img id="profilePicImage" style="max-width: 300px; max-height: 300px; display:none;">
        <br>
        <button id="confirmBtn" disabled>Weiter</button>
        </div>
      `,
      css_classes: ['id-panel'],
      choices: [], // no keyboard input
      on_load: function(){
        let cropper;
        const fileInput = document.getElementById('profilePicInput');
        const imageEl = document.getElementById('profilePicImage');
        const confirmBtn = document.getElementById('confirmBtn');

        fileInput.addEventListener('change', function(){
          const file = fileInput.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = function(e){
            imageEl.src = e.target.result;
            imageEl.style.display = 'block';

            // Destroy previous cropper if exists
            if (cropper) cropper.destroy();

            // Initialize Cropper.js
            cropper = new Cropper(imageEl, {
              aspectRatio: 1,      // square crop
              viewMode: 1,
              movable: true,
              zoomable: true,
              rotatable: false,
              scalable: false,
            });

            confirmBtn.disabled = false; // enable button
          };
          reader.readAsDataURL(file);
        });

        confirmBtn.addEventListener('click', function(){
          if (!cropper) return;
          const croppedCanvas = cropper.getCroppedCanvas({ width: 200, height: 200 });
          const croppedDataUrl = croppedCanvas.toDataURL('image/png');

          // Send to backend
          const id = jsPsych.data.get().last(1).values()[0].participant_id; // optional: use participant ID
          fetch('upload_profile_pic.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ participant_id: id, image: croppedDataUrl })
          }).then(res => res.text())
            .then(response => console.log(response))
            .catch(err => console.error(err));

          // Finish trial (uploaded flag)
          jsPsych.finishTrial({ uploaded: true });
        });
      },
      on_start: function(trial) {
      // fade in after content is added to DOM
      setTimeout(() => {
        const container = document.querySelector('.fade-container');
        if(container) container.classList.add('visible');
      }, 10);
    },
    on_finish: function() {
      // fade out before next trial
      const container = document.querySelector('.fade-container');
      if(container) container.classList.remove('visible');
    }
    };

  // --- 5 separate profile question trials ---
  const q1_trial = {
    type: jsPsychSurveyText,
    questions: [
      { prompt: `<div class="fade-container">${q1_string}</div>`, rows: 2, columns: 50, required: true, name: "q1" }
    ],
    button_label: "Weiter",
    css_classes: ['id-panel'],
    on_finish: function(data) {
      jsPsych.data.addProperties({ q1: data.response.q1 });
    },
    on_start: function(trial) {
      // fade in after content is added to DOM
      setTimeout(() => {
        const container = document.querySelector('.fade-container');
        if(container) container.classList.add('visible');
      }, 10);
    },
    on_finish: function() {
      // fade out before next trial
      const container = document.querySelector('.fade-container');
      if(container) container.classList.remove('visible');
    }
  };

  const q2_trial = {
    type: jsPsychSurveyText,
    questions: [
      { prompt: `<div class="fade-container">${q2_string}</div>`, rows: 2, columns: 50, required: true, name: "q2" }
    ],
    button_label: "Weiter",
    css_classes: ['id-panel'],
    on_finish: function(data) {
      jsPsych.data.addProperties({ q2: data.response.q2 });
    },
    on_start: function(trial) {
      // fade in after content is added to DOM
      setTimeout(() => {
        const container = document.querySelector('.fade-container');
        if(container) container.classList.add('visible');
      }, 10);
    },
    on_finish: function() {
      // fade out before next trial
      const container = document.querySelector('.fade-container');
      if(container) container.classList.remove('visible');
    }
  };

  const q3_trial = {
    type: jsPsychSurveyText,
    questions: [
      { prompt: `<div class="fade-container">${q3_string}</div>`, rows: 2, columns: 50, required: true, name: "q3" }
    ],
    button_label: "Weiter",
    css_classes: ['id-panel'],
    on_finish: function(data) {
      jsPsych.data.addProperties({ q3: data.response.q3 });
    },
    on_start: function(trial) {
      // fade in after content is added to DOM
      setTimeout(() => {
        const container = document.querySelector('.fade-container');
        if(container) container.classList.add('visible');
      }, 10);
    },
    on_finish: function() {
      // fade out before next trial
      const container = document.querySelector('.fade-container');
      if(container) container.classList.remove('visible');
    }
  };

  const q4_trial = {
    type: jsPsychSurveyText,
    questions: [
      {prompt: `<div class="fade-container">${q4_string}</div>`, rows: 2, columns: 50, required: true, name: "q4" }
    ],
    button_label: "Weiter",
    css_classes: ['id-panel'],
    on_finish: function(data) {
      jsPsych.data.addProperties({ q4: data.response.q4 });
    },
    on_start: function(trial) {
      // fade in after content is added to DOM
      setTimeout(() => {
        const container = document.querySelector('.fade-container');
        if(container) container.classList.add('visible');
      }, 10);
    },
    on_finish: function() {
      // fade out before next trial
      const container = document.querySelector('.fade-container');
      if(container) container.classList.remove('visible');
    }
  };

  const q5_trial = {
    type: jsPsychSurveyText,
    questions: [
      { prompt: `<div class="fade-container">${q5_string}</div>`, rows: 2, columns: 50, required: true, name: "q5" }
    ],
    button_label: "Weiter",
    css_classes: ['id-panel'],
    on_finish: function(data) {
      jsPsych.data.addProperties({ q5: data.response.q5 });

      // Save all responses after last question
      const id = jsPsych.data.get().filter({ trial_type: 'survey-text' }).values()[0].participant_id ||
                jsPsych.data.get().first(1).values()[0].participant_id;

      const stored = jsPsych.data.get().values()[0];
      const header = ["ID", "Q1", "Q2", "Q3", "Q4", "Q5"];
      const row = [
        id,
        `"${stored.q1 || ""}"`,
        `"${stored.q2 || ""}"`,
        `"${stored.q3 || ""}"`,
        `"${stored.q4 || ""}"`,
        `"${data.response.q5 || ""}"`
      ].join(",");
      saveData(id + ".csv", header.join(",") + "\n" + row);
    },
    on_finish: function() {
      // fade out before next trial
      const container = document.querySelector('.fade-container');
      if(container) container.classList.remove('visible');
      },
    on_start: function(trial) {
      // fade in after content is added to DOM
      setTimeout(() => {
        const container = document.querySelector('.fade-container');
        if(container) container.classList.add('visible');
      }, 10);
    },
  };

    // --- Image finder function (checks extensions on server) ---
    async function findExistingImage(id) {
      const extensions = ['png', 'jpg', 'jpeg', 'bmp', 'webp'];
      for (const ext of extensions) {
        const path = `profile_pics/${id}.${ext}`;
        try {
          // HEAD is lighter than GET
          const res = await fetch(path, { method: 'HEAD' });
          if (res.ok) return path;
        } catch (e) {
          // ignore
        }
      }
      return "profile_pics/default.png"; // fallback
    }

    // --- Trial that finds the correct image path BEFORE the preview ---
    const find_image_trial = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: "Bitte warten, während das Profilbild überprüft wird...",
      choices: "NO_KEYS",
      trial_duration: null,
      on_start: async function(trial) {
        const id = jsPsych.data.get().last(1).values()[0].participant_id;
        try {
          currentImagePath = await findExistingImage(id);
        } catch (err) {
          console.error("Fehler beim Prüfen des Bildes:", err);
          currentImagePath = "profile_pics/default.png";
        }
        jsPsych.finishTrial();
      },
    };

    const end = {
      type: jsPsychHtmlButtonResponse,
      stimulus: "<h2>Vielen Dank für deine Teilnahme!</h2><p>Dein Profil wurde gespeichert. Du kannst das Fenster nun schließen.</p>",
      choices: ["Schließen"],
      on_finish: function() {
        window.close();
      },
    };

    const profile_preview = {
  type: jsPsychHtmlButtonResponse,
  css_classes: ['id_panel', 'profile'],
  stimulus: function() {
    const id = jsPsych.data.get().first(1).values()[0].participant_id || "Unbekannt";

    const surveyData = jsPsych.data.get().filter({trial_type: 'survey-text'}).last(5).values();
    const data = {
      q1: surveyData[0].response.q1,
      q2: surveyData[1].response.q2,
      q3: surveyData[2].response.q3,
      q4: surveyData[3].response.q4,
      q5: surveyData[4].response.q5
    };

    const img_html = `
      <img src="${currentImagePath}?t=${Date.now()}" 
           style="max-width:150px; max-height:150px; border-radius:50%; margin-bottom: 20px;">
    `;

    const qa_html = `
      <div class="qa-row"><span class="qa-label"><b>${q1_string}</b></span><span class="qa-answer">${data.q1}</span></div>
      <div class="qa-row"><span class="qa-label"><b>${q2_string}</b></span><span class="qa-answer">${data.q2}</span></div>
      <div class="qa-row"><span class="qa-label"><b>${q3_string}</b></span><span class="qa-answer">${data.q3}</span></div>
      <div class="qa-row"><span class="qa-label"><b>${q4_string}</b></span><span class="qa-answer">${data.q4}</span></div>
      <div class="qa-row"><span class="qa-label"><b>${q5_string}</b></span><span class="qa-answer">${data.q5}</span></div>
    `;

    return `
      <div class="fade-container">
        ${img_html}
        <div class="qa-container">
          ${qa_html}
        </div>
      </div>
    `;
  },
  choices: ["Profil akzeptieren", "Profil bearbeiten"],
  button_html: [
  `<button class="accept">%choice%</button>`,
  `<button class="edit">%choice%</button>`
  ],
  on_start: function(trial) {
    // fade in after content is added to DOM
    setTimeout(() => {
      const container = document.querySelector('.fade-container');
      if(container) container.classList.add('visible');
    }, 10);
  },
  on_finish: function(data) {
    // fade out
    const container = document.querySelector('.fade-container');
    if(container) container.classList.remove('visible');

    // decide if user wants to redo profile
    redoProfilePic = data.response === 1; // true → repeat if edit
  }
};


    // --- Updated profile loop ---
  const profile_loop = {
    timeline: [
      profile_pic_trial,
      question_instructions,
      q1_trial,
      q2_trial,
      q3_trial,
      q4_trial,
      q5_trial,
      find_image_trial,
      profile_preview
    ],
    loop_function: function() {
      return redoProfilePic; // true → repeat if user wants to edit
    }
  };

  // --- Timeline ---
  var timeline = [];
  timeline.push(id_timeline);
  timeline.push(welcome);
  timeline.push(profile_loop); // loop for editing profile
  timeline.push(end);

  // --- Start experiment ---
  jsPsych.run(timeline);
}
</script>
</html>

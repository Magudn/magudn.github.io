<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Profil Bewerten</title>
  <script src="jspsych-7.1.2/dist/jspsych.js"></script>
  <script src="jspsych-7.1.2/dist/plugin-html-button-response.js"></script>
  <script src="jspsych-7.1.2/dist/plugin-html-keyboard-response.js"></script>
  <script src="jspsych-7.1.2/dist/plugin-survey-text.js"></script>
  <link href="jspsych-7.1.2/dist/jspsych.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  <link href="jspsych-7.1.2/dist/jspsych.css" rel="stylesheet" />
  <link rel="stylesheet" href="style.css">
  <style>
    .eval-img {
      width: 100px;
      cursor: pointer;
      margin: 0 20px;
      transition: transform 0.2s ease, filter 0.2s ease, opacity 0.2s ease;
    }

    .eval-img:hover {
      transform: scale(1.1);
    }

    .eval-disabled {
      cursor: default;
      opacity: 0.5;
      transform: scale(0.9);
      pointer-events: none;
    }

    .eval-selected {
      transform: scale(1.2);
      pointer-events: none;
    }
  </style>
</head>

<body>
  <script src="question_strings.js"></script>
</body>

<script>
const jsPsych = initJsPsych();
let currentSurveyData = {};
let currentImagePath = "";
let validIDs = [];
let selectedIDs = [];

// --- Load IDs first ---
fetch('ids.json')
  .then(response => response.json())
  .then(data => {
    validIDs = ["00001",
  "00002",
  "00003",
  "00004",
  "00005",];
    pickRandomIDs(5);
    startExperiment();
  })
  .catch(err => {
    alert("Konnte die ID-Datenbank nicht laden.");
    console.error(err);
  });

// --- Pick n unique random IDs ---
function pickRandomIDs(n) {
  const shuffled = [...validIDs].sort(() => 0.5 - Math.random());
  selectedIDs = shuffled.slice(0, n);
}

// --- CSV parsing ---
function parseCSVLine(line) {
  const regex = /(?:\"([^\"]*)\")|([^,]+)/g;
  const result = [];
  let match;
  while ((match = regex.exec(line)) !== null) {
      result.push(match[1] !== undefined ? match[1] : match[2]);
  }
  return result;
}

function loadCSVData(id) {
  const filePath = `db/${id}.csv`;
  return fetch(filePath)
      .then(response => {
          if (!response.ok) throw new Error("CSV file not found");
          return response.text();
      })
      .then(csvText => {
          const rows = csvText.trim().split("\n");
          const headers = parseCSVLine(rows[0]);
          const values = parseCSVLine(rows[1]);
          const data = {};
          headers.forEach((header, i) => { data[header] = values[i]; });
          return data;
      });
}

// --- Image finder ---
async function findExistingImage(id) {
  const extensions = ['png', 'jpg', 'jpeg', 'bmp', 'webp'];
  for (const ext of extensions) {
    const path = `profile_pics/${id}.${ext}`;
    try {
      const res = await fetch(path, { method: 'HEAD' });
      if (res.ok) return path;
    } catch (e) {}
  }
  return "profile_pics/default.png";
}

function startExperiment() {

  // --- Add logo to the page ---
  const logo = document.createElement('img');
  logo.src = 'zi.png';  // make sure this file is in the same folder as your HTML
  logo.className = 'top-logo';
  document.body.prepend(logo);  // adds logo at the top of body

  const instructions = {
    type: jsPsychHtmlButtonResponse,
    stimulus: `
      <h2>Willkommen!</h2>
      <p>In diesem Experiment werden wir dir mehrere Profile anzeigen.</p>
      <p>Bitte bewerte jedes Profil mit Like oder Dislike.</p>
    `,
    choices: ["Weiter"],
    css_classes: ['id-panel'],
    on_start: function() {
      const wrapper = document.querySelector('.jspsych-content-wrapper');

      // Add logo if not already added
      if (!wrapper.querySelector('.top-logo')) {
        const logo = document.createElement('img');
        logo.src = 'zi.png';  // must be in same folder
        logo.className = 'top-logo';
        wrapper.prepend(logo);
      
      }
      // Add footnote if not already added
      if (!wrapper.querySelector('.footnote')) {
        const footnote = document.createElement('div');
        footnote.className = 'footnote';
        footnote.innerText = '© 2025 ZI Mannheim – Alle Rechte vorbehalten';
        wrapper.appendChild(footnote);
      }
    }

  };

  const profileTimeline = selectedIDs.map(id => {
    const loadCSVTrial = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: "Bitte warten, während die Profildaten geladen werden...",
      choices: "NO_KEYS",
      trial_duration: null,
      on_start: async function(trial) {
        try {
          currentSurveyData = await loadCSVData(id);
          currentImagePath = await findExistingImage(id);
        } catch(err) {
          console.error(err);
          currentSurveyData = { Q1:"Fehler", Q2:"Fehler", Q3:"Fehler", Q4:"Fehler", Q5:"Fehler" };
          currentImagePath = "profile_pics/default.png";
        }
        jsPsych.finishTrial();
      }
    };

    const profileTrial = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: function() {
    return `
      <div style="display:flex; justify-content:center; align-items:flex-start; margin-top:20px; gap:40px;">

        <!-- Left panel (styled like first block) -->
        <div class="profile" style="max-width: 750px;">
          <img src="${currentImagePath}?t=${Date.now()}" 
               style="max-width:150px; max-height:150px; border-radius:50%; margin-bottom:20px;">
          
          <div class="qa-container">
            <div class="qa-row"><span class="qa-label"><b>${q1_string}</b></span><span class="qa-answer">${currentSurveyData.Q1}</span></div>
            <div class="qa-row"><span class="qa-label"><b>${q2_string}</b></span><span class="qa-answer">${currentSurveyData.Q2}</span></div>
            <div class="qa-row"><span class="qa-label"><b>${q3_string}</b></span><span class="qa-answer">${currentSurveyData.Q3}</span></div>
            <div class="qa-row"><span class="qa-label"><b>${q4_string}</b></span><span class="qa-answer">${currentSurveyData.Q4}</span></div>
            <div class="qa-row"><span class="qa-label"><b>${q5_string}</b></span><span class="qa-answer">${currentSurveyData.Q5}</span></div>
          </div>
        </div>

        <!-- Right column -->
        <div style="display:flex; flex-direction:column; justify-content:center; align-items:center;">
          <img src="dep_img/like.bmp" id="like-btn" class="eval-img" style="margin-bottom:30px;">
          <img src="dep_img/dislike.bmp" id="dislike-btn" class="eval-img">
        </div>

      </div>
    `;
  },
  choices: [],
  trial_duration: null,
  response_ends_trial: false,
  on_start: function(trial) {
    setTimeout(() => {
      const likeBtn = document.getElementById("like-btn");
      const dislikeBtn = document.getElementById("dislike-btn");

      likeBtn.addEventListener("click", () => {
        likeBtn.classList.add("eval-selected");
        dislikeBtn.classList.add("eval-disabled");

        jsPsych.data.addProperties({ evaluation: "Like", profileID: id });
        setTimeout(() => jsPsych.finishTrial(), 3000);
      });

      dislikeBtn.addEventListener("click", () => {
        dislikeBtn.classList.add("eval-selected");
        likeBtn.classList.add("eval-disabled");

        jsPsych.data.addProperties({ evaluation: "Dislike", profileID: id });
        setTimeout(() => jsPsych.finishTrial(), 3000);
      });
    }, 50);
  }
};


    return [loadCSVTrial, profileTrial];
  }).flat();

  const test_trial = {
    type: jsPsychHtmlButtonResponse,
    stimulus: "<h2>Test trial: Alles funktioniert!</h2><p>Dies ist eine kleine Testnachricht nach allen Profilen.</p>",
    choices: ["Weiter"],
    css_classes: ['id-panel'],
  };

  jsPsych.run([instructions, ...profileTimeline, test_trial]);
}
</script>
</html>

